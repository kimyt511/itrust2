<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>Document Office Visit</title>
<script th:src="@{/js/dateTimeService.js}"
		src="../js/dateTimeService.js"></script>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">

		<script th:inline="javascript">
			/* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
			/*<![CDATA[*/

			var app = angular.module('myApp', ['dateTimeServices']);
			app.controller('editPatientDemographicsCtrl', function($scope, $http, dateTimeService) {
				$scope.displayName = function(p) {
					return p.firstName + " " + p.lastName + " (" + p.username + ")";
				}
				
				// documentation on Angular filters: https://docs.angularjs.org/api/ng/filter/filter
				$scope.searchFilter = "";
				$scope.filterPatients = function(patient) {
					return ($scope.displayName(patient)).toLowerCase().match($scope.searchFilter.toLowerCase());
				}
				
				function formDifferent(current, original) {
					for (var field in original) {
						if (current[field] != original[field]) return true;
					}
					return false;
				}

				$scope.prescriptions = [];
				$scope.pattern = /^\d{4}-\d{4}-\d{2}$/;
				$scope.loadTable = function (username) {
				$http.get("/iTrust2/api/v1/prescriptions/"+username).then(
					function (response) {
					$scope.prescriptions = response.data;
					$scope.message = "";
					}, function (rejection) {
					$scope.prescriptions = [];
					$scope.message = "Could not display prescriptions";
					});
				}
				
				$scope.originalForm = {};
				$scope.patientForm = {};
				
				$scope.selectPatient = function(patient, override) {
					if (!override && formDifferent($scope.patientForm, $scope.originalForm)) {
						if (!confirm("You have made changes to " + $scope.patientForm.username
								+ ". Would you like to continue? (changes will be lost)")) {
							$scope.selectedPatient = "";
							$scope.selectedPatient = $scope.patientForm.username;
							return;
						}
					}
					
					var pf = $scope.patientForm = {};
					var of = $scope.originalForm = {};
					
					// make a copy of the patient
					for (var field in patient) {
						if (field[0] == '$') continue; // don't mess with angular fields
						pf[field] = of[field] = patient[field];
					}
					var dateOfBirth = new Date(of.dateOfBirth);
					var today = new Date();
					pf.age = today.getFullYear() - dateOfBirth.getFullYear();
					var monthDiff = today.getMonth() - dateOfBirth.getMonth();
					if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
						pf.age--;
					}
					// pf.age = today;
					pf.dateOfBirth = dateOfBirth.toDateString().format("yyyy-MM-dd");
					pf.username = of.username = patient.username;
					// swap out enum id's for names
					for (var i in $scope.bloodTypes)
						if (patient.bloodType == $scope.bloodTypes[i].id) {
							pf.bloodType = of.bloodType = $scope.bloodTypes[i].name;
							break;
						}
					for (var i in $scope.genders)
						if (patient.gender == $scope.genders[i].id) {
							pf.gender = of.gender = $scope.genders[i].name;
							break;
						}
					
					$scope.selectedPatient = pf.username;

					$http.get("/iTrust2/api/v1/diagnosis/"+pf.username).then(
					function(response) {
						$scope.diagnoses = response.data;
						$scope.message = "";
					}, function(rejection) {
						$scope.diagoses = [];
						$scope.message = "Unable to display diagnoses";
					});

					$scope.loadTable(pf.username);

				}

				$http.get("/iTrust2/api/v1/patients").then(
						function(response) {
							$scope.patients = response.data;
						});
				
				$http.get("/iTrust2/api/v1/bloodtype").then(
						function(response) {
							$scope.bloodTypes = response.data;
						});
				
				$http.get("/iTrust2/api/v1/gender").then(
						function(response) {
							$scope.genders = response.data;
						});

				$scope.submit = function() {
					var patient = angular.copy($scope.patientForm);
					patient.dateOfBirth = dateTimeService.toDateString(patient.dateOfBirth).format('yyyy-MM-dd');

					$http({
						method : 'PUT',
						url : '/iTrust2/api/v1/patients/' + patient.username,
						data : patient
					}).then(function(response) {
						$scope.message = "Patient demographics updated successfully.";
						
						// replace the patient in session 
						for (var i in $scope.patients)
							if ($scope.patients[i].username == response.data.username) {
								$scope.patients[i] = response.data;
								$scope.selectPatient(response.data, true);
							}
					}, function(rejection) {
						if (rejection.data.msg) {
							$scope.message = "Error: " + rejection.data.msg;
						} else {
							$scope.message = "An error occured updating demographics.";
						}
					})
				}
			});

			/*]]>*/
		</script>



		<div ng-app="myApp" ng-controller="editPatientDemographicsCtrl">
			<div style="float: left; width: 30%; height: 75%; overflow-y: auto">
				<h2>Patients:</h2>
				<!-- info on filtering taken from here: https://www.w3schools.com/angular/angular_filters.asp
				and https://docs.angularjs.org/api/ng/filter/filter -->
				<h4>
					Name: <input type="text" name="searchName" ng-model="searchNameFilter" />
				</h4>
				<h4>
					MID: <input type="text" name="searchMID" ng-model="searchMIDFilter" />
				</h4>
				<!-- Info on scrolling taken from here: https://www.w3schools.com/cssref/pr_pos_overflow.asp -->
				<!-- and here: https://stackoverflow.com/questions/9560330/how-to-hide-a-vertical-scroll-bar-when-not-needed -->
				<ul style="overflow: auto;height=90%;">
					<!-- Information on how labels wor from here: https://stackoverflow.com/questions/7863251/clicking-the-text-to-select-corresponding-radio-button -->
					<li ng-repeat="patient in patients | filter:filterPatients"><h4>
							<label> <input type="radio"
								ng-model="$parent.selectedPatient" name="patient"
								value="{{patient.username}}"
								ng-click='$parent.selectPatient(patient)' />&nbsp;{{$parent.displayName(patient)}}
							</label>
						</h4></li>
				</ul>
			</div>
			<!-- information on vertical rule found here: https://stackoverflow.com/questions/571900/is-there-a-vr-vertical-rule-in-html  -->
			<div
				style="float: left; width: 70%; border-left: 1px solid #bbb; padding-left: 3%; height: 75%; overflow-y: auto">
				<h2 id="header0">Emergency Health Records</h2>
				<div ng-show="selectedPatient">
					<!-- <h3>Username: {{selectedPatient}}</h3> -->
					<h3>Demographics: </h3>
					<table>
						<tr>
							<td style="text-align: right; padding: 5px"><b>First
									Name:</b></td>
							<td name="firstName", ng-bind="patientForm.firstName"></td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>Last
									Name:</b></td>
							<td name="lastName", ng-bind="patientForm.lastName"></td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>MID:</b></td>
							<td>{{selectedPatient}}</td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>Age:</b></td>
							<td name="Age", ng-bind="patientForm.age"></td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>Date of
									Birth:</b></td>
							<!-- <td><input type="date" name="dateOfBirth"
								ng-model="patientForm.dateOfBirth" /></td> -->
							<td name="dateOfBirth", ng-bind="patientForm.dateOfBirth"></td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>Gender:</b></td>
							<!-- <td><select name="gender" ng-model="patientForm.gender">
									<option ng-repeat="gen in genders">{{gen.name}}</option>
							</select></td> -->
							<td name="gender", ng-bind="patientForm.gender"></td>
						</tr>
						<tr>
							<td style="text-align: right; padding: 5px"><b>Blood
									Type:</b></td>
							<!-- <td><select name="bloodType"
								ng-model="patientForm.bloodType">
									<option ng-repeat="bt in bloodTypes">{{bt.name}}</option>
							</select></td> -->
							<td name="bloodType", ng-bind="patientForm.bloodType"></td>
						</tr>
						
					</table>

					<h3>Diagnoses</h3>
					<table style="width: 100%" class="table table-hover">
						<thead>
							<tr>
								<th>Date</th>
								<th>ICD-10 Code</th>
							</tr>
						</thead>
						<tbody>
							<tr ng-repeat="d in diagnoses | orderBy: 'visit' " name="diagnosis">
								<td name="date">{{d.visit.date}}</td>
								<td name="code">{{d.code.code}}</td>
							</tr>
						</tbody>
					</table>

					<h3>Prescriptions</h3>
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>Drug</th>
								<th>Dosage (mg)</th>
								<th>Start Date</th>
								<th>End Date</th>
								<th>Renewals</th>
							</tr>
						</thead>
						<tbody>
							<tr name="prescriptionTableRow"
								ng-repeat="p in prescriptions | orderBy: 'startDate'"
								prescriptionId={{p.id}}>
								<td name="drugCell">{{p.drug.name}}</td>
								<td name="codeCell">{{p.dosage}}</td>
								<td name="startCell">{{p.startDate | date :
									'MM/dd/yyyy'}}</td>
								<td name="endCell">{{p.endDate | date : 'MM/dd/yyyy'}}</td>
								<td name="renewalsCell">{{p.renewals}}</td>
							</tr>
						</tbody>
					</table>
					<br />
					<!-- <button ng-click="submit()" name="submit">Submit</button> -->

					<div name="success">{{message}}</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>