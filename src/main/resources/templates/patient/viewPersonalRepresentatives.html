<html xmlns:th="http://www.thymeleaf.org">

<head th:include="layout :: head(title=~{::title},links=~{})">
    <title>Personal Representatives</title>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
<div th:fragment="content">

    <!-- To be completed ----------->
    <script th:inline="javascript">
        /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
        /*<![CDATA[*/

        // define Angular JS module
        const app = angular.module("PersonalRepresentativesApp", []);

        // define Angular Js controller
        app.controller('PersonalRepresentativesCtrl', function ($scope, $http) {

            ///////////////////////get current user(patient)//////////////////////////////////////////
            $http.get("/iTrust2/api/v1/patient").then(function (response) {
                $scope.currentPatient = response.data;
                }, function (rejection) {
                    console.error("Could not retrieve expected Patient record");
                }
            );
            ///////////////////////get current user(patient)//////////////////////////////////////////

            //Initialize data container, access these variables in html part below
            ////////////////////////////My Representatives & patient data////////////////////////////////////////
            $scope.loadTable = function () {
                ////////////////////////////My Representatives data//////////////////////////////////////////////
                // API endpoint connection to myRepresentatives
                $http.get("/iTrust2/api/v1/pr/myrepresentatives").then(
                    function (response) {
                        console.log(response.data);
                        $scope.myRepresentatives = response.data;
                        $scope.message = "";
                    }, function (rejection) {
                        $scope.representatives = [];
                        $scope.message = "Could not display representatives";
                    }
                );
                ////////////////////////////My Patients data//////////////////////////////////////////////
                // API endpoint connection to myPatients
                $http.get("/iTrust2/api/v1/pr/mypatients").then(
                    function (response) {
                        console.log(response.data);
                        $scope.myPatients = response.data;
                        $scope.message = "";
                    }, function (rejection) {
                        $scope.representatives = [];
                        $scope.message = "Could not display patients";
                    }
                );
            };
            ////////////////////////////My Representatives & patient data////////////////////////////////////////

            ////////////////Refresh Function////////////////////////////////
            $scope.refreshTable = function() {
                // Reload the table
                $scope.loadTable();
            };
            ////////////////Refresh Function////////////////////////////////


            ////////////////////////////Undeclare Representatives//////////////////////////////////////////////

            // Initialize array to track selected representatives
            $scope.selectedRepresentatives = [];

            ///////////////////Updating selected Representatives/////////////////////
            // Function to update the selectedRepresentatives array
            $scope.updateSelectedRepresentatives = function (representative) {
                if (representative.selected) {
                    $scope.selectedRepresentatives.push(representative);
                } else {
                    // Remove from the array if deselected
                    const index = $scope.selectedRepresentatives.indexOf(representative);
                    if (index !== -1) {
                        $scope.selectedRepresentatives.splice(index, 1);
                    }
                }
            };
            ///////////////////Updating selected Representatives/////////////////////

            /////////////Actual Function that undeclare representatives//////////////////
            $scope.undeclareSelectedRepresentatives = function () {
                // Send requests to undeclare each selected representative
                $scope.selectedRepresentatives.forEach(function (representative) {
                    $http.delete('/iTrust2/api/v1/pr/undeclare/' + representative.id)
                        .then(function (response) {
                            console.log('Undeclare request successful');
                            $scope.message= "Undeclaration confirmed successfully";
                            $scope.refreshTable();
                        })
                        .catch(function (error) {
                            // Handle error, if needed
                            console.error('Error in undeclare request');
                        }
                    );
                });

                // Reset the selectedRepresentatives array
                $scope.selectedRepresentatives = [];
            };
            /////////////Actual Function that undeclare Representatives//////////////////
            ////////////////////////////Undeclare Representatives//////////////////////////////////////////////

            ////////////////////////////Undeclare Patients////////////////////////////////////////////////////
            // Initialize array to track selected representatives
            $scope.selectedPatients = [];

            ///////////////////Updating selected Patientss///////////////////
            // Function to update the patients array
            $scope.updateSelectedPatients = function (patient) {
                if (patient.selected) {
                    $scope.selectedPatients.push(patient);
                } else {
                    // Remove from the array if deselected
                    const index = $scope.selectedPatients.indexOf(representative);
                    if (index !== -1) {
                        $scope.selectedPatients.splice(index, 1);
                    }
                }
            };
            ///////////////////Updating selected Patients/////////////////////

            /////////////Actual Function that undeclare Patients/////////////////////
            $scope.undeclareSelectedPatients = function () {
                // Send requests to undeclare each selected patient
                $scope.selectedPatients.forEach(function (patient) {
                    $http.delete('/iTrust2/api/v1/pr/undeclare/' + patient.id)
                        .then(function (response) {
                            console.log('Undeclare request successful');
                            $scope.message= "Undeclaration confirmed successfully";
                            $scope.refreshTable();
                        })
                        .catch(function (error) {
                            // Handle error, if needed
                            console.error('Error in undeclare request');
                        }
                    );
                });

                // Reset the selectedRepresentatives array
                $scope.selectedPatients = [];
            };
            /////////////Actual Function that undeclare Patients//////////////////

            ////////////////////////////Undeclare Patients //////////////////////////////////////////////

            ////////////////////////////Search Section////////////////////////////////////////////////////

            // Function to display the search section
            $scope.showDeclareRepresentative = function () {
                // Toggle the visibility of the search section
                $scope.showSearchSection = !$scope.showSearchSection;
            };

            $scope.displayName = function (p) {
                return p.firstName + " " + p.lastName + " (" + p.id + ")";
            };

            // documentation on Angular filters: https://docs.angularjs.org/api/ng/filter/filter
            $scope.searchFilter = "";
            $scope.filterPatients = function (patient) {
                 return ($scope.displayName(patient)).toLowerCase().match($scope.searchFilter.toLowerCase());
            };

            $http.get("/iTrust2/api/v1/patients").then(
                  function (response) {
                       $scope.patients = response.data;
                  }
            );

            //initialize search results container
            $scope.searchResults = [];

            /////////////////////update search filter////////////////////////////////////
            $scope.selectedPatient = null;
            $scope.declare = { patient: "", representative: "", comment: "" };

            $scope.selectPatient = function(patient) {
                $scope.selectedPatient = patient;
                $scope.declare.representative = patient.username;
                // Update the search filter to display the selected patient's name or MID in the search box
                $scope.searchFilter = $scope.displayName(patient);
                $scope.declare.patient = $scope.currentPatient.username;
            };
            /////////////////////update search filter////////////////////////////////////
            ////////////////////////////Search Section////////////////////////////////////////////////////

            ////////////////////////////Declare Representative////////////////////////////////////////////////////
            // Function to declare a representative
            $scope.declareRepresentative = function() {
                if ($scope.selectedPatient) {
                    // Send the selected patient as a representative to the backend
                    // need to be modified here.
                    $http.post("/iTrust2/api/v1/pr/declare", $scope.declare)
                .then(
                    function(response) {
                        $scope.message = "Declaration confirmed successfully";
                        $scope.refreshTable();

                        //reset the selected patient and search filter after declaring
                        $scope.selectedPatient = null;
                        $scope.searchFilter = '';
                    },
                    function(rejection) {
                        $scope.message = "Failed to confirm declaration";
                    }
                );
                } else {
                    // Handle the case where no patient is selected
                    $scope.message = "No patient selected for declaration";
                }
            };
            ////////////////////////////Declare Representative////////////////////////////////////////////////////

		    ///////////////////////////Initially Load Table/////////////////////////
			$scope.loadTable();

        });
        /*]]>*/
    </script>

    <!-- Contents -->
    <div ng-app="PersonalRepresentativesApp" ng-controller="PersonalRepresentativesCtrl">
        <div class="container">
            <div class="row">
                <div class="col-md-8" style="margin-left: 15%;">
                    <!--------------------------------- Panel--------------------------------------------------->
                    <div class="panel panel-primary mx-auto d-flex justify-content-center">
                        <div class="panel-heading">
                            <h3>Personal Representatives</h3>
                        </div>
                        <div class="panel-body">

                            <!------------------------- Representative of ---------------------------------->
                            <table class="table table-bordered">
                                <caption>
                                    Representative for:
                                    <button ng-click="undeclarePatients()" style="float: right;">
                                        Undeclare
                                    </button>
                                </caption>
                                <thead>
                                <tr>
                                    <th style="width: 200px;">Name</th>
                                    <th style="width: 200px;">MID</th>
                                    <!--
                                    <th>Comment</th>
                                    -->
                                    <th style="width: 50px;">Select</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Contents -->
                                <tr name="patientsTableRow"
                                    ng-repeat="p in myPatients"
                                    representativeId={{p.id}}>
                                    <td name="nameCell">{{p.patient.firstName
                                                        ? p.patient.firstName + " " + p.patient.lastName
                                                        : p.patient.username}}</td>
                                    <td name="midCell">{{p.patient.id}}</td>
                                    <!--
                                    <td name="commentCell">{{p.comment}}</td>
                                    -->

                                    <!--------target of undeclaration------>
                                    <td class="text-center" name="selectCell">
                                        <input ng-change="updateSelectedPatients(p)" ng-model="p.selected"
                                               type="checkbox">
                                        <!--------target of undeclaration------>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <!------------------------- Representative of ---------------------------------->

                            <!------------------------- My Representatives --------------------------------->
                            <table class="table table-bordered">
                                <caption>
                                    My Representatives:
                                    <button ng-click="undeclareRepresentatives()" style="float: right;">
                                        Undeclare
                                    </button>
                                </caption>
                                <thead>
                                <tr>
                                    <th style="width: 200px;">Name</th>
                                    <th style="width: 200px;">MID</th>
                                    <!--
                                    <th>Comment</th>
                                    -->
                                    <th style="width: 50px;">Select</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Contents -->
                                <tr name="RepresentativesTableRow"
                                    ng-repeat="r in myRepresentatives"
                                    representativeId={{r.id}}>
                                    <td name="nameCell">{{r.representative.firstName
                                                        ? r.representative.firstName + " " + r.representative.lastName
                                                        : r.representative.username}}</td>
                                    <td name="midCell">{{r.representative.id}}</td>
                                    <!--
                                    <td name="commentCell">{{r.comment}}</td>
                                    -->

                                    <!--------target of undeclaration------>
                                    <td class="text-center" name="selectCell">
                                        <input ng-change="updateSelectedRepresentatives(r)" ng-model="r.selected"
                                               type="checkbox">
                                        <!--------target of undeclaration------>
                                </tr>

                                </tbody>
                            </table>
                            <!------------------------- My Representatives --------------------------------->
                        </div>
                    </div>
                    <!--------------------------------- Panel--------------------------------------------------->


                    <!-------------------------Button to declare a representative------------>
                    <!---This button shows hidden search section---->
                    <div class="text-center" style="margin-bottom: 20px;">
                        <button class="btn btn-primary" ng-click="showDeclareRepresentative()">
                            Declare a Representative
                        </button>
                    </div>
                    <!-------------------------Button to declare a representative------------>

                    <!----------------------------- Search Section----------------------------------->
                    <div class="search-section" ng-show="showSearchSection">
                        <!-- Search Form -->
                        <form>
                            <div class="form-row align-items-center">
                                <div style="float: left;padding-left: 5%; margin-right: 20px;">
                                    <label style="font-size: 2rem;">Enter Name or MID:</label>
                                </div>
                                <div style="float: left; margin-right: 20px;">
                                    <input name="search" ng-model="searchFilter"
                                           style="width:520px; height: 30px;text-align: left;"
                                           type="text">
                                </div>
                                <div style="float: left;">
                                    <button class="btn btn-primary" ng-click="declareRepresentative()">
                                        Declare
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div style="clear: both;"></div>
                        <!-- Search Results -->
                        <div style="margin-left:254px">
                            <ul class="list-group">
                                <li class="list-group-item" ng-repeat="patient in patients | filter:filterPatients"
                                    ng-if="patient.username !== currentPatient.username"
                                    style="width: 520px; height:40px;">
                                    <!--To be completed-->
                                    <div>
                                        <label ng-click="$parent.selectPatient(patient)"
                                               style="font-size: 18px; cursor: pointer;">
                                            {{ $parent.displayName(patient) }}
                                        </label>
                                    </div>
                                    <!--To be completed-->
                                </li>
                            </ul>
                        </div>

                        <!-- No result message
                        <div ng-if="(patient in patients | filter:filterPatients).length === 0">
                            <p style="font-size: 1.5rem;">No matching patients found.</p>
                        </div>
                        -->
                    </div>
                    <!----------------------------- Search Section----------------------------------->
                </div>
            </div>
        </div>
    </div>
</div>
</body>

</html>

<!--FOR API TESTING PURPOSE
<form class="form-horizontal" role="form" name="addRepresentativeForm"
      ng-submit="testDeclare(addRepresentativeForm.$valid)">
    <input type="text" name="patient" ng-model="repr.patient" placeholder="Patient" />
    <input type="text" name="representative" ng-model="repr.representative" placeholder="Representative" />
    <input type="text" name="comment" ng-model="repr.comment" placeholder="Comment" />
    <button type="submit" name="submit">Declare</button>
</form>
END API TESTING -->
