<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{::script})">
    <title>Patient Personal Representatives</title>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
<div th:fragment="content">

    <script th:inline="javascript">
        /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
        /*<![CDATA[*/

        const app = angular.module('HCPPersonalRepresentativeApp', []);
        app.controller('HCPPersonalRepresentativeCtrl', function ($scope, $http) {

            $scope.displayName = function (p) {
                return p.firstName + " " + p.lastName + " (" + p.username + ")";
            };

            //////////////////////////////Search for patient, part 1/////////////////////////////////////
             // documentation on Angular filters: https://docs.angularjs.org/api/ng/filter/filter
            $scope.searchFilter = "";
            $scope.filterPatients = function (patient) {
                return ($scope.displayName(patient)).toLowerCase().match($scope.searchFilter.toLowerCase());
            };

            $http.get("/iTrust2/api/v1/patients").then(
                function (response) {
                    $scope.patients = response.data;
                }
            );

            /////////////////////update search filter////////////////////////////////////
            $scope.selectedPatient = null;

            $scope.selectPatient = function(patient) {
                $scope.selectedPatient = patient;
                // Update the search filter to display the selected patient's name or MID in the search box
                $scope.searchFilter = $scope.displayName(patient);

                // Toggle the visibility of the search section
                if($scope.showSearchSection){
                    $scope.showSearchSection = !$scope.showSearchSection;
                    $scope.searchFilter2 = "";
                }
            };
            //////////////////////////////Search for patient, part 1/////////////////////////////////////


            ////////////////////////////My Representatives & patient data////////////////////////////////////////
            $scope.loadTable = function () {
                ////////////////////////////My Representatives data//////////////////////////////////////////////
                // API endpoint connection to PRs of selected patient
                $http.get("/iTrust2/api/v1/pr/"+$scope.selectedPatient.id).then(
                    function (response) {
                        console.log(response.data);
                        $scope.PRofSelected = response.data;
                        $scope.rindex = 1;
                        $scope.message = "";
                    }, function (rejection) {
                        $scope.representatives = [];
                        $scope.message = "Could not display representatives";
                    }
                );
                ////////////////////////////My Patients data//////////////////////////////////////////////
                // API endpoint connection to patients of selected patient
                //need to be changed here
                $http.get("/iTrust2/api/v1/pr/"+$scope.selectedPatient.id).then(
                    function (response) {
                        console.log(response.data);
                        $scope.PofSelected = response.data;
                        $scope.pindex = 1;
                        $scope.message = "";
                    }, function (rejection) {
                        $scope.representatives = [];
                        $scope.message = "Could not display patients";
                    }
                );
            };
            ////////////////////////////My Representatives & patient data////////////////////////////////////////

            ////////////////Refresh Function////////////////////////////////
            $scope.refreshTable = function() {
                // Reload the table
                $scope.loadTable();
            };
            ////////////////Refresh Function////////////////////////////////

            // Function to display the search section
            $scope.showAssign = function () {
                // Toggle the visibility of the search section
                $scope.showSearchSection = !$scope.showSearchSection;
            };

            //////////////////////////////Search for patient, part 2/////////////////////////////////////
            $http.get("/iTrust2/api/v1/patients").then(
                function (response) {
                    $scope.patients2 = response.data;
                }
            );

            $scope.selectedPatient2 = null;
            $scope.declare = { patient: "", representative: "", comment: "" };
            $scope.searchFilter2 = "";

            $scope.selectPatient2 = function(patient2) {
                $scope.selectedPatient2 = patient2;
                $scope.declare.representative = $scope.selectedPatient2.username;
                // Update the search filter to display the selected patient's name or MID in the search box
                $scope.searchFilter2 = $scope.displayName(patient2);
                $scope.declare.patient = $scope.selectedPatient.username;
            };

            $scope.filterPatients2 = function (patient2) {
                return ($scope.displayName(patient2)).toLowerCase().match($scope.searchFilter2.toLowerCase());
            };
            //////////////////////////////Search for patient, part 2/////////////////////////////////////

            ////////////////////////////Confirm Representative////////////////////////////////////////////////////
            // Function to declare a representative
            $scope.confirmRepresentative = function() {
                if ($scope.selectedPatient) {
                    // Send the selected patient as a representative to the backend
                    // need to be modified here.
                    $http.post("/iTrust2/api/v1/pr/declare", $scope.declare)
                        .then(
                            function(response) {
                                $scope.declareMessage = "Declaration confirmed successfully";
                                $scope.refreshTable();

                                //reset the selected patient2 and search filter after declaring
                                $scope.selectedPatient2 = null;
                                $scope.searchFilter2 = '';
                                /////////////////////////////update Table/////////////////////////
                            },
                            function(rejection) {
                                $scope.declareMessage = "Failed to confirm declaration: " + rejection.data.message;
                            }
                        );
                } else {
                    // Handle the case where no patient is selected
                    $scope.message = "No patient selected for declaration";
                }
            };
            ////////////////////////////Confirm Representative////////////////////////////////////////////////////

        });

        /*]]>*/
    </script>


    <!-- need to be modified -->
    <!-- The controller should be defined -->
    <!-- Here used editPatientDemographicsCtrl" to give an idea -->
    <div ng-app="HCPPersonalRepresentativeApp" ng-controller="HCPPersonalRepresentativeCtrl">
        <div style="float: left; width: 20%; height: 75%; overflow-y: auto">
            <h3>Search Patients:</h3>
            <!-- info on filtering taken from here: https://www.w3schools.com/angular/angular_filters.asp
                and https://docs.angularjs.org/api/ng/filter/filter -->
            <h4 style = "padding-left: 2%">
                <input type="text" name="search" ng-model="searchFilter" style = "padding-left: 2%"/>
            </h4>
            <!-- Info on scrolling taken from here: https://www.w3schools.com/cssref/pr_pos_overflow.asp -->
            <!-- and here: https://stackoverflow.com/questions/9560330/how-to-hide-a-vertical-scroll-bar-when-not-needed -->
            <ul class="list-group" style="overflow: auto;height: 90%; padding-left: 0%">
                <li class="list-group-item" ng-repeat="patient in patients | filter:filterPatients"
                    style="width: 215px; height:40px;">
                    <!--To be completed-->
                    <div>
                        <label ng-click="$parent.selectPatient(patient); $parent.refreshTable()"
                               style="font-size: 18px; cursor: pointer;">
                            {{ $parent.displayName(patient) }}
                        </label>
                    </div>
                    <!--To be completed-->
                </li>
            </ul>
        </div>
        <!-- information on vertical rule found here: https://stackoverflow.com/questions/571900/is-there-a-vr-vertical-rule-in-html  -->
        <div style="float: left; width: 75%; border-left: 1px solid #bbb;padding-left: 3%; height: 100%; overflow-y: auto">
            <h2 id="header0">Personal Representatives</h2>
            <div ng-show="selectedPatient">
                <h3>Username: {{selectedPatient.id}}</h3>
                <h4>Representatives of</h4>
                <table border="1" style="width: 100%;">
                    <tr>
                        <td style="text-align: center; padding: 5px; width: 50px;"><b>No.</b></td>
                        <td style="text-align: center; padding: 5px; width: 150px"><b>Name</b></td>
                        <td style="text-align: center; padding: 5px; width: 150px"><b>MID</b></td>
                    </tr>

                    <tr name="RepresentativesTableRow"
                        ng-repeat="r in PRofSelected"
                        representativeId={{r.id}}>
                        <td name="nameCell">
                            {{r.representative.firstName
                            ? r.representative.firstName + " " + r.representative.lastName
                            : r.representative.username}}</td>
                        <td name="midCell">{{r.representative.id}}</td>
                    </tr>

                </table>
                <h4>Representative for: </h4>
                <table border="1" style="width: 100%;">
                    <tr>
                        <td style="text-align: center; padding: 5px; width: 50px;"><b>No.</b></td>
                        <td style="text-align: center; padding: 5px; width: 150px"><b>Name</b></td>
                        <td style="text-align: center; padding: 5px; width: 150px"><b>MID</b></td>
                    </tr>

                    <tr name="patientsTableRow"
                        ng-repeat="p in PofSelected"
                        patientId={{p.id}}>
                        <td name="nameCell">
                            {{p.patient.firstName
                            ? p.patient.firstName + " " + p.patient.lastName
                            : p.patient.username}}</td>
                        <td name="midCell">{{p.patient.id}}</td>
                    </tr>

                </table>
                <br/>

                <div class="text-center">
                    <button class="btn btn-primary" ng-click="showAssign()">assign</button>
                </div>
            </div>

                <!-- Search Section -->
            <div ng-show="showSearchSection" class="search-section">
                    <!-- Search Form -->
                <form>
                    <div class="form-row align-items-center">
                        <div style="float: left;padding-left: 10%; margin-right: 20px;">
                            <label style="font-size: 2.2rem;">Enter Name or MID:</label>
                        </div>
                        <div style="float: left; margin-right: 20px;">
                            <input type="text" ng-model="searchFilter2"  style="width:520px; height: 35px"
                                       placeholder="Enter name or MID">
                        </div>
                        <div style="float: left;">
                            <button class="btn btn-primary" ng-click="confirmRepresentative()">
                                confirm
                            </button>
                        </div>
                    </div>
                </form>
                <div style="clear: both;"></div>
                <!-- Search Results -->
                <div>
                    <ul class="list-group" style="overflow: auto;height: 90%; padding-left: 0%">
                        <li class="list-group-item" ng-repeat="patient2 in patients2 | filter:filterPatients2"
                            ng-if="selectedPatient.username !== patient2.username"
                            style="width: 520px; height:35px;margin-left: 330px;">
                            <!--To be completed-->
                            <div >
                                <label ng-click="$parent.selectPatient2(patient2)"
                                       style="font-size: 16px; cursor: pointer;">
                                    {{ $parent.displayName(patient2) }}
                                </label>
                            </div>
                            <!--To be completed-->
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>